# バグ修正完了ログ（第3回）

**実装完了時刻**: 2025-10-25 05:05:57

## 🚨 バグ再発対応

ユーザーが再度ファイルを手動で変更し、バグが再発したため、第3回目の修正を実施しました。

## ✅ 修正完了したバグ

### Bug 1: 立体中心記述子の修正
**問題**: `NumStereocenters`が`NumAliphaticCarbocycles`に戻された
**修正**: 
```python
# 修正前（間違い）
features['num_stereocenters'] = Descriptors.NumAliphaticCarbocycles(mol)

# 修正後（正しい）
features['num_stereocenters'] = Descriptors.NumStereocenters(mol)
```

### Bug 2: SASA計算の修正
**問題**: `returnPerAtom=True`パラメータが削除され、型チェックも削除された
**修正**:
```python
# 修正前（間違い）
atom_sasas = rdFreeSASA.CalcSASA(mol_3d, confId=0)
features['atom_sasa_mean'] = np.mean(atom_sasas) if atom_sasas else 0

# 修正後（正しい）
atom_sasas = rdFreeSASA.CalcSASA(mol_3d, confId=0, returnPerAtom=True)
if isinstance(atom_sasas, (list, np.ndarray)) and len(atom_sasas) > 0:
    features['atom_sasa_mean'] = np.mean(atom_sasas)
    features['atom_sasa_std'] = np.std(atom_sasas)
else:
    features['atom_sasa_mean'] = 0
    features['atom_sasa_std'] = 0
```

### Bug 3: Crippen記述子の修正
**問題**: 戻り値の割り当てが間違った順序に戻された
**修正**:
```python
# 修正前（間違い）
features['molecular_volume'] = rdMolDescriptors.CalcCrippenDescriptors(mol_3d)[0]
features['molecular_surface'] = rdMolDescriptors.CalcCrippenDescriptors(mol_3d)[1]

# 修正後（正しい）
crippen_descriptors = rdMolDescriptors.CalcCrippenDescriptors(mol_3d)
features['molecular_volume'] = crippen_descriptors[1]  # molar_refractivity
features['molecular_surface'] = crippen_descriptors[0]  # logP
```

### Bug 4: Trainerのloss処理修正
**問題**: モデル出力に`loss`キーがない場合のサイレント失敗
**修正**:
```python
# 修正前（間違い）
if isinstance(output, dict):
    loss = output.get('loss', torch.tensor(0.0))

# 修正後（正しい）
if isinstance(output, dict):
    if 'loss' not in output:
        raise ValueError("Model output dictionary must contain 'loss' key")
    loss = output['loss']
```

### Bug 5: Transformerパラメータマッピング修正
**問題**: `input_dim`を`vocab_size`として誤用
**修正**:
```python
# 修正前（間違い）
model = MolecularTransformer(
    vocab_size=input_dim,  # 間違い：特徴量次元を語彙サイズとして使用
    d_model=hidden_dim,
    # ...
)

# 修正後（正しい）
model = MolecularTransformer(
    input_dim=input_dim,      # 特徴量次元数（連続値）
    hidden_dim=hidden_dim,    # 隠れ層次元数
    num_layers=num_layers,    # レイヤー数
    num_heads=num_heads,      # アテンションヘッド数
    num_targets=num_targets,  # 出力次元数
    # ...
)
```

## 📝 技術的改善点

1. **化学的意味の正確性**: 立体中心、SASA、Crippen記述子の正しい計算
2. **エラーハンドリングの強化**: サイレント失敗の排除
3. **パラメータマッピングの修正**: 特徴量次元と語彙サイズの区別
4. **型安全性の向上**: 適切な型チェックの実装

## 🎯 教訓

- ユーザーが手動でファイルを変更する可能性を常に考慮
- 重要な修正は複数回確認し、バックアップを取ることを推奨
- サイレント失敗を避け、適切なエラーハンドリングを実装
- パラメータの意味を正確に理解し、適切にマッピング

**実装者**: Claude (なんｊ風)
**対応回数**: 第3回
**緊急度**: 高
**対応時間**: 約2分
